<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Babel</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width">
	<link rel="stylesheet" href="css/style.css">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
	<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="socket.io/socket.io.js"></script>
	<script src="js/p5.js"></script>
	<script src="js/sound.js"></script>
	<script src="js/jquery.particleground.min.js"></script>
	<script src="js/jquery.js"></script>
</head>
<body>
	<div id="processing">
	</div>
	<div id="background">
	</div>
	<div id="about">
		<section>
			<article>
				<h2>Hah, thought you woud never ask!</h2>
				<p>The project is inspired by the <a href="http://en.wikipedia.org/wiki/Tower_of_Babel">Tower of Babel</a>.</p>
				<p>Once upon a time, all people on earth understood each other. But their language was confounded.</p>
				<p>This web app is symbolising the meaning of the Tower of Babel.
					 Everyone is represented by an bubble, which pulsates and beeps.
					 Even if you and other visitors speaking the same language, no one
					 would ever understand what you are saying.</p>
				<i class="fa fa-comments-o"></i>
			</article>
		</section>
	</div>
	<section class="name">
		<input type='text' class='loginname' placeholder='What is your Name?'>
		<input type='submit' class='submit' value='Submit'>
	</section>
	<p class="info">
		Please put on your headphones!<br>
		<a class="what" href="#">What is this?</a><br>
		Code & Design: <a href="http://www.niklasbarning.de">Niklas Barning</a><br>
		<a href="https://github.com/barning/babel">Fork me on Github</a>
	</p>


	<script>
	var socket = io();
	var boids = [];
	var input;
	var analyzer;

/*
	Initialize Sketch
	-----------------
*/
	function preload() {
		mic = new p5.AudioIn(); //Create new Mic-In
		mySound = loadSound('audio/underwater.mp3'); //Load audiofile
	}

	function setup() {
		mic.start(); //Start the recording
		mySound.loop(); //Start and loop the audiofile
		mySound.setVolume(0.5); //Set Volume of audiofile
		var myCanvas = createCanvas(windowWidth, windowHeight); //Create new Canvas
		myCanvas.parent('processing'); //Insert canvas into <div id="processing"></div>
		sizeforServer();
		/*
			Initialize the Particleground.js
			--------------------------------
		*/
		$('#background').particleground({
			dotColor: '#374F66',
			lineColor: '#374F66',
			particleRadius: 25,
			parallaxMultiplier: 30,
			density: 35000,
			proximity: 150
		});
	}

	function draw() {
		clear(); //Clear the image, so the background is transparent
		fill(100);
		textAlign(CENTER);
		fill(255);
		noStroke();
		for (var i = 0; i < boids.length; i++) {
			boids[i].run(boids); //Start the "run"function for every boid
		}
		if (boids.length ==1){ //If only one boid is visible, show text
			fill(255);
			textAlign(LEFT);
			textSize(24);
			text("You are alone.",width/2+50,height/2);
			text("Invite a friend or wait until someone",width/2+50,height/2+30);
			text("comes to this place.",width/2+50,height/2+60);
		}
		getSound();
	}

	/*
		Here comes the Boid
		-------------------
	*/

	function Boid(x, y,number) {
		this.position = createVector(x, y);
		this.mynumber = number;
		this.r = 0;
		this.color=color(0,0,0);
		this.myname;
		this.osc = new p5.Oscillator(500); //Initialize a new OSC
		this.osc.start(); //Start the OSC
		this.osc.amp(0.2); //Set the volume of the OSC
		this.reverb = new p5.Reverb(); //Initialize a new Reverb
		this.reverb.process(this.osc, 6, 5); //Connect Reverb to the OSC
	}

	Boid.prototype.run = function(boids) {
		this.render();
	}

	Boid.prototype.render = function() {
		fill(this.color);
		ellipseMode(CENTER);
		if (this.myname != undefined){ //When the user sets a name, show the name
			textSize(18);
			text(this.myname , this.position.x+90, this.position.y+5);
		}
		ellipse(this.position.x, this.position.y,this.r,this.r);
		var loudness = map(this.r,30,80,900,1); //Map this.r between 900 and 1
		var panning = map(this.position.x,0,width,-1,1); //Set the Stereosound depending on the X-Position of the Boid
		this.osc.pan(panning);
		if (loudness >890) {
			loudness = 5;
		}
		this.osc.freq(loudness); //Insert Loudness into the frequency
	}
	function playerCount (){
		socket.emit ('Update');
	}

/*
	Count msg and initialize new boids
	-----------------------------------
*/
	socket.on ('updateBoids', function (msg) {
		var length = msg;
		for (var i = 0; i < length; i++) {
			var x= random(50,windowWidth-50);
			var y= random(50,windowHeight-130);
			boids[i] = new Boid(x,y,i );
			socket.emit ('who',{myX:x,myY: y});
		}
	});

/*
	Delete the Boid of the disconnected player
	---------------------------------------------
*/
	socket.on ('deletePlayer', function (msg) {
		boids[msg].osc.stop();
		boids[msg].osc.disconnect();
		boids.splice(msg,1);
	});

/*
	Get the miclevel and sends it to the server
	--------------------------------------------
*/
	function getSound(){
		var vol = mic.getLevel();
		var r = constrain(80-vol*80*5, 0, 80);
		socket.emit ('mySound', r);
	}

/*
	Send the Browsersize to the server
	-----------------------------------
*/
	function sizeforServer () {
		var _docHeight = (document.height !== undefined) ? document.height : document.body.offsetHeight;
		var _docWidth = (document.width !== undefined) ? document.width : document.body.offsetWidth;
		socket.emit ('mySize',{mywidth: _docWidth, myheight: _docHeight});
	}

/*
	Set the name of the boid
	-------------------------
*/
	socket.on ('newName', function (data) {
		var tempName = data.name;
		var number = data.number;
		console.log(tempName);
		var theboidforname = boids[number];
		theboidforname.myname = tempName;
	});

/*
	Set the radius of the boid
	----------------------------
*/
	socket.on ('mylevel', function (data) {
		var tempName = data.name;
		var tempSound = data.level;
		var theboidforsound = boids[tempName];
		theboidforsound.r = tempSound;
	});

/*
	Set the position, color and name of the boid
	----------------------------
*/
	socket.on ('youare', function (data) {
		tempx = data.posX;
		tempy = data.posY;
		tempMynumber = data.name;
		tempMyname = data.registeredName;
		r = data.tempr;
		g = data.tempg;
		b = data.tempb;
		var boid = boids[tempMynumber];
		boid.position.x = tempx;
		boid.position.y = tempy;
		boid.color = color(r,g,b);
		boid.myname = tempMyname;
	});
	</script>
</body>
</html>
