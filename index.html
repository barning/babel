<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Babel</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width">
	<link rel="stylesheet" href="css/style.css">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
	<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="js/p5.js"></script>
	<script src="js/sound.js"></script>

</head>
<body>
	<div id="processing">
	</div>
	<div id="about">
		<section>
			<article>
				<h2>Hah, thought you woud never ask!</h2>
				<p>The project is inspired by the <a href="http://en.wikipedia.org/wiki/Tower_of_Babel">Tower of Babel</a>.</p>
				<p>Once upon a time, all people on earth understood each other. But their language was confounded.</p>
				<p>This web app is symbolising the meaning of the Tower of Babel. Everyone is represented by an bubble, which pulsates and beeps. Even if you and other visitors speaking the same language, no one would ever understand what you are saying.</p>
				<i class="fa fa-comments-o"></i>
			</article>
		</section>
	</div>
	<section class="name">
		<input type='text' class='loginname' placeholder='What is your Name?'>
		<input type='submit' class='submit' value='Submit'>
	</section>	
	<p class="info">
		Please put on your headphones!<br>
		<a  class="what" href="#">What is this?</a><br>
		Code & Design: <a href="http://www.niklasbarning.de">Niklas Barning</a><br>
		<a href="https://github.com/barning/babel">Fork me on Github</a>
	</p>
	<script src="socket.io/socket.io.js"></script>

	<script>
	function registerName() {
		socket.emit('register', { name: $(".loginname").val() , email: "franz@aol.de"} );
		console.log($(".loginname").val());
	}

	$(document).ready( function() {
		$(".submit").click( function() {
			registerName();
			$( ".name" ).fadeOut( "slow", function() {
			// Animation complete.
			});
		});	
		$(".what").click( function() {
			$( "#about" ).fadeIn( "slow", function() {
			});
		});
		$("#about").click( function() {
			$( "#about" ).fadeOut( "slow", function() {
			});
		});	
	});
	</script>


	<script>
	var socket = io();
	var boids = [];
	var input;
	var analyzer;

	function preload() {
		mic = new p5.AudioIn();
		mic.start();
		mySound = loadSound('audio/underwater.mp3');
	}

	function setup() {
		mySound.loop();
		mySound.setVolume(0.5);

		var myCanvas = createCanvas(windowWidth, windowHeight);
		myCanvas.parent('processing');
		sizeforServer();

	}

	function draw() {
		background(44, 62, 80);
		fill(100);
		textAlign(CENTER);
		fill(255);
		noStroke();

		for (var i = 0; i < boids.length; i++) {
			boids[i].run(boids);
		}
		if (boids.length ==1){
			fill(255);
			textAlign(LEFT);
			textSize(24);
			text("You are alone.",width/2+50,height/2);
			text("Invite a friend or wait until someone",width/2+50,height/2+30);
			text("comes to this place.",width/2+50,height/2+60);
		}
		getSound();
	}

//CLass
function Boid(x, y,number) {
	this.position = createVector(x, y);
	this.mynumber = number;
	this.r = 0;
	this.color=color(0,0,0);
	this.osc = new p5.Oscillator(500);
	this.osc.start();
	this.osc.amp(0.2);

	this.myname;

// Create a reverb input
this.reverb = new p5.Reverb();
this.reverb.process(this.osc, 6, 5);
}

Boid.prototype.run = function(boids) {
	this.render();
}

Boid.prototype.render = function() {
	fill(this.color);
	ellipseMode(CENTER);
	if (this.myname != undefined){
		textSize(18);
		text(this.myname , this.position.x+90, this.position.y+5); 
	}
	ellipse(this.position.x, this.position.y,this.r,this.r);

	var loudness = map(this.r,30,80,900,1);
	var panning = map(this.position.x,0,width,-1,1);
	this.osc.pan(panning);
	if (loudness >890) {
		loudness = 5;
	}

	this.osc.freq(loudness);

}

function playerCount (){
	socket.emit ('Update');
}


socket.on ('updateBoids', function (msg) {
	var length = msg;
	for (var i = 0; i < length; i++) {
		var x= random(50,windowWidth-50);
		var y= random(50,windowHeight-130);
		boids[i] = new Boid(x,y,i );
		socket.emit ('who',{myX:x,myY: y});
	} 
});


socket.on ('deletePlayer', function (msg) {
	boids[msg].osc.stop();
	boids[msg].osc.disconnect();
	boids.splice(msg,1);
});

function getSound(){
	var vol = mic.getLevel();
	var r = constrain(80-vol*80*5, 0, 80);
	socket.emit ('mySound', r);
}

function sizeforServer () {
	var _docHeight = (document.height !== undefined) ? document.height : document.body.offsetHeight;
	var _docWidth = (document.width !== undefined) ? document.width : document.body.offsetWidth;
	socket.emit ('mySize',{mywidth: _docWidth, myheight: _docHeight});
}  

socket.on ('newName', function (data) {
	var tempName = data.name;
	var number = data.number;
	console.log(tempName);
	var theboidforname = boids[number];
	theboidforname.myname = tempName;
});

socket.on ('mylevel', function (data) {
	var tempName = data.name;
	var tempSound = data.level;
	var theboidforsound = boids[tempName];
	theboidforsound.r = tempSound;
});

socket.on ('youare', function (data) {
	tempx = data.posX;
	tempy = data.posY;
	tempMynumber = data.name;
	tempMyname = data.registeredName;
	r = data.tempr;
	g = data.tempg;
	b = data.tempb;
	var boid = boids[tempMynumber];
	boid.position.x = tempx;
	boid.position.y = tempy;
	boid.color = color(r,g,b);
	boid.myname = tempMyname;
});
</script>    
</body>
</html>
