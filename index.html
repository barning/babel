<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Babel</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width">
	<link rel="stylesheet" href="css/style.css">
	<script src="js/p5.js"></script>
	<script src="js/sound.js"></script>

</head>
<body>
	<div id="processing">
	</div>
	<p class="info">
		Please put on your headphones!<br>
		<!-- Music: <a href="https://soundcloud.com/pascal-seul">Pascal Seul</a><br> -->
		Code & Design: <a href="http://www.niklasbarning.de">Niklas Barning</a><br>
		<a href="https://github.com/barning/babel">Fork me on Github</a>
	</p>
	<script src="socket.io/socket.io.js"></script>
	<script>

var socket = io();
var boids = [];
var input;
var analyzer;

function setup() {
  // Create an Audio input
  mic = new p5.AudioIn();
  mic.start();

  var myCanvas = createCanvas(windowWidth, windowHeight);
  myCanvas.parent('processing');

}

function draw() {
	background(44, 62, 80,50);
	fill(100);
	textAlign(CENTER);
	fill(255);
	noStroke();
	
	for (var i = 0; i < boids.length; i++) {
		boids[i].run(boids);
	}
	getSound();
}

//CLass
function Boid(x, y,number) {
	this.position = createVector(x, y);
	this.mynumber = number;
	this.r = 0;
	this.color=color(0,0,0);
	this.osc = new p5.Oscillator(500);
	this.osc.start();
	this.osc.amp(0.2);

	// Create a reverb input
  	this.reverb = new p5.Reverb();
  	this.reverb.process(this.osc, 6, 5);
}

Boid.prototype.run = function(boids) {
	this.render();
}

Boid.prototype.render = function() {
  fill(this.color);
  ellipseMode(CENTER);
  //text("I'm "+this.mynumber , this.position.x+60, this.position.y); 
  ellipse(this.position.x, this.position.y,this.r,this.r);
  
  var loudness = map(this.r,30,80,900,1);
  var panning = map(this.position.x,0,width,-1,1);
  this.osc.pan(panning);
  if (loudness >890) {
  	loudness = 5;
  }

  this.osc.freq(loudness);

}

function playerCount (){
	socket.emit ('Update');
}


socket.on ('updateBoids', function (msg) {
	var length = msg;
	for (var i = 0; i < length; i++) {
		boids[i] = new Boid(0,0,i );
		socket.emit ('who',i);
	} 
});


socket.on ('deletePlayer', function (msg) {
	boids[i].osc.disconnect();
	boids.splice(msg,1);
});

function getSound(){
	var vol = mic.getLevel();
	var r = constrain(80-vol*80*5, 0, 80);
	socket.emit ('mySound', r);
}

socket.on ('mylevel', function (data) {
	var tempName = data.name;
	var tempSound = data.level;
	var theboidforsound = boids[tempName];
	theboidforsound.r = tempSound;
});

socket.on ('youare', function (data) {
	tempx = data.posX;
	tempy = data.posY;
	tempMynumber = data.name;
	r = data.tempr;
	g = data.tempg;
	b = data.tempb;
	var boid = boids[tempMynumber];
	boid.position.x = tempx;
	boid.position.y = tempy;
	boid.color = color(r,g,b);
});
socket.on ('theSize', function () {
  var _docHeight = (document.height !== undefined) ? document.height : document.body.offsetHeight;
  var _docWidth = (document.width !== undefined) ? document.width : document.body.offsetWidth;
  socket.emit ('mySize',{mywidth: _docWidth, myheight: _docHeight});
});  
</script>    
</body>
</html>
